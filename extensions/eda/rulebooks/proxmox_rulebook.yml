---
- name: Monitor Proxmox for Stopped Instances
  hosts: localhost
  # Note: Proxmox connection variables must be provided when activating this rulebook
  # Required variables: proxmox_host, proxmox_node, proxmox_user, proxmox_token_id, proxmox_token_secret, proxmox_verify_ssl
  # Optional: proxmox_poll_delay (default: 30 seconds)
  sources:
    - name: proxmox_monitor
      proxmox_monitor:
        host: "{{ proxmox_host }}"
        node: "{{ proxmox_node }}"
        user: "{{ proxmox_user }}"
        token_id: "{{ proxmox_token_id }}"
        token_secret: "{{ proxmox_token_secret }}"
        verify_ssl: "{{ proxmox_verify_ssl }}"
        delay: 30

  rules:
    - name: Remediate Stopped VM (Unexpected Shutdown/Crash)
      condition: >
        event.proxmox.type == "vm" and
        event.proxmox.status == "stopped" and
        event.proxmox.previous_status == "running" and
        event.meta.event_type == "vm_stopped_unexpectedly"
      action:
        run_playbook:
          name: playbooks/start_proxmox_instance.yml
          extra_vars:
            target_vmid: "{{ event.proxmox.vmid }}"
            target_node: "{{ event.proxmox.node }}"
            vm_name: "{{ event.proxmox.name }}"
            instance_type: "vm"
            proxmox_host: "{{ proxmox_host }}"
            proxmox_node: "{{ proxmox_node }}"
            proxmox_user: "{{ proxmox_user }}"
            proxmox_token_id: "{{ proxmox_token_id }}"
            proxmox_token_secret: "{{ proxmox_token_secret }}"
            proxmox_verify_ssl: "{{ proxmox_verify_ssl }}"

    - name: Remediate Stopped LXC (Unexpected Shutdown/Crash)
      condition: >
        event.proxmox.type == "lxc" and
        event.proxmox.status == "stopped" and
        event.proxmox.previous_status == "running" and
        event.meta.event_type == "vm_stopped_unexpectedly"
      action:
        run_playbook:
          name: playbooks/start_proxmox_instance.yml
          extra_vars:
            target_vmid: "{{ event.proxmox.vmid }}"
            target_node: "{{ event.proxmox.node }}"
            vm_name: "{{ event.proxmox.name }}"
            instance_type: "lxc"
            proxmox_host: "{{ proxmox_host }}"
            proxmox_node: "{{ proxmox_node }}"
            proxmox_user: "{{ proxmox_user }}"
            proxmox_token_id: "{{ proxmox_token_id }}"
            proxmox_token_secret: "{{ proxmox_token_secret }}"
            proxmox_verify_ssl: "{{ proxmox_verify_ssl }}"
...
